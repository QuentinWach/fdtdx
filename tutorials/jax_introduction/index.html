<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Yannik Mahlau and Frederik Schubert" /><link rel="canonical" href="https://ymahlau.github.io/fdtdx/tutorials/jax_introduction/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>JAX in FDTDX - FDTDX</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "JAX in FDTDX";
        var mkdocs_page_input_path = "tutorials/jax_introduction.md";
        var mkdocs_page_url = "/fdtdx/tutorials/jax_introduction/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script>
  <meta name="google-site-verification" content="YRg1ahIy0iLUWtpahY6KK3sAmEVrkXqiqgCi0nI3r5g" />

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../..">
          <img src="../../img/logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorials</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">JAX in FDTDX</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#functional-programming-paradigm">Functional Programming Paradigm</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pure-functions-only">Pure Functions Only</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#no-side-effects">No Side Effects</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#immutable-data">Immutable Data</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../object_placement/">Object Placement</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../materials/">Materials Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../parameter_mapping/">Fabrication Constraints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../interface_compression/">Interface Compression</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../notebooks/modes/">Mode Source and Detector</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../notebooks/simulate_lossy_material/">Lossy materials using conductivity</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Public</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/apply_params/">fdtdx.apply_params</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/ArrayContainer/">fdtdx.ArrayContainer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/autoinit/">fdtdx.autoinit</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/BinaryMedianFilterModule/">fdtdx.BinaryMedianFilterModule</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/boundary_objects_from_config/">fdtdx.boundary_objects_from_config</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/BoundaryConfig/">fdtdx.BoundaryConfig</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/BrushConstraint2D/">fdtdx.BrushConstraint2D</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/circular_brush/">fdtdx.circular_brush</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/ClosestIndex/">fdtdx.ClosestIndex</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/compute_energy/">fdtdx.compute_energy</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/compute_poynting_flux/">fdtdx.compute_poynting_flux</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/ConnectHolesAndStructures/">fdtdx.ConnectHolesAndStructures</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/constants/">fdtdx.constants</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/Cylinder/">fdtdx.Cylinder</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/Device/">fdtdx.Device</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/DiagonalSymmetry2D/">fdtdx.DiagonalSymmetry2D</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/DtypeConversion/">fdtdx.DtypeConversion</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/EnergyDetector/">fdtdx.EnergyDetector</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/ExtrudedPolygon/">fdtdx.ExtrudedPolygon</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/FieldDetector/">fdtdx.FieldDetector</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/GaussianPlaneSource/">fdtdx.GaussianPlaneSource</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/GaussianPulseProfile/">fdtdx.GaussianPulseProfile</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/GaussianSmoothing2D/">fdtdx.GaussianSmoothing2D</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/GradientConfig/">fdtdx.GradientConfig</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/GridCoordinateConstraint/">fdtdx.GridCoordinateConstraint</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/LinearReconstructEveryK/">fdtdx.LinearReconstructEveryK</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/Logger/">fdtdx.Logger</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/Material/">fdtdx.Material</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/metric_efficiency/">fdtdx.metric_efficiency</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/ModeOverlapDetector/">fdtdx.ModeOverlapDetector</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/ModePlaneSource/">fdtdx.ModePlaneSource</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/ObjectContainer/">fdtdx.ObjectContainer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/ParameterTransformation/">fdtdx.ParameterTransformation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/PerfectlyMatchedLayer/">fdtdx.PerfectlyMatchedLayer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/PeriodicBoundary/">fdtdx.PeriodicBoundary</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/PhasorDetector/">fdtdx.PhasorDetector</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/PillarDiscretization/">fdtdx.PillarDiscretization</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/place_objects/">fdtdx.place_objects</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/plot_setup/">fdtdx.plot_setup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/PositionConstraint/">fdtdx.PositionConstraint</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/PoyntingFluxDetector/">fdtdx.PoyntingFluxDetector</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/RealCoordinateConstraint/">fdtdx.RealCoordinateConstraint</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/Recorder/">fdtdx.Recorder</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/RecordingState/">fdtdx.RecordingState</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/RemoveFloatingMaterial/">fdtdx.RemoveFloatingMaterial</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/run_fdtd/">fdtdx.run_fdtd</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/SimulationConfig/">fdtdx.SimulationConfig</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/SimulationObject/">fdtdx.SimulationObject</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/SimulationVolume/">fdtdx.SimulationVolume</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/SingleFrequencyProfile/">fdtdx.SingleFrequencyProfile</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/SizeConstraint/">fdtdx.SizeConstraint</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/SizeExtensionConstraint/">fdtdx.SizeExtensionConstraint</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/Sphere/">fdtdx.Sphere</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/StandardToCustomRange/">fdtdx.StandardToCustomRange</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/StandardToPlusOneMinusOneRange/">fdtdx.StandardToPlusOneMinusOneRange</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/SubpixelSmoothedProjection/">fdtdx.SubpixelSmoothedProjection</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/TanhProjection/">fdtdx.TanhProjection</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/TreeClass/">fdtdx.TreeClass</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/typing/">fdtdx.typing</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/UniformMaterialObject/">fdtdx.UniformMaterialObject</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/UniformPlaneSource/">fdtdx.UniformPlaneSource</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/public/WaveCharacter/">fdtdx.WaveCharacter</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Internal</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../api/internal/compression/">Compression Base Classes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/internal/detector/">Detector Base Class</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/internal/objects/">Object Base Classes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/internal/sources/">Source Base Classes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../api/internal/transformation/">Parameter Transformation Base Classes</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">FDTDX</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Tutorials</li>
      <li class="breadcrumb-item active">JAX in FDTDX</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/ymahlau/fdtdx/edit/main/docs/tutorials/jax_introduction.md">Edit on ymahlau/fdtdx</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="introduction-to-jax">Introduction to JAX</h2>
<p>JAX is a high-performance numerical computing library developed by Google that brings together the familiar NumPy API with powerful features like automatic differentiation, just-in-time (JIT) compilation, and seamless GPU/TPU acceleration. Originally designed for machine learning research, JAX has become popular across scientific computing applications due to its speed and flexibility.</p>
<p>Jax itself provides a good introduction <a href="https://docs.jax.dev/en/latest/tutorials.html">here</a> and <a href="https://docs.jax.dev/en/latest/notebooks/Common_Gotchas_in_JAX.html">here</a>. Otherwise, the following is a small crash course.</p>
<h3 id="functional-programming-paradigm">Functional Programming Paradigm</h3>
<p>JAX operates exclusively in a functional programming style, which means it requires you to write pure functions without side effects. This functional approach has several important implications:</p>
<h3 id="pure-functions-only">Pure Functions Only</h3>
<p>JAX functions cannot modify variables in-place or maintain internal state. Instead of operations like array[0] = 5, you must use functional equivalents like array.at[0].set(5) that return new arrays.
<div class="highlight"><pre><span></span><code><span class="c1"># This won&#39;t work in JAX</span>
<span class="k">def</span><span class="w"> </span><span class="nf">bad_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># In-place modification</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="c1"># This is the JAX way</span>
<span class="k">def</span><span class="w"> </span><span class="nf">good_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Returns new array</span>
</code></pre></div></p>
<h3 id="no-side-effects">No Side Effects</h3>
<p>Functions should not print to console, write to files, or modify global variables during compilation. JAX's JIT compiler optimizes based on the assumption that functions are deterministic and side-effect free.</p>
<h3 id="immutable-data">Immutable Data</h3>
<p>Arrays and other data structures are treated as immutable. Operations create new objects rather than modifying existing ones, similar to how NumPy handles broadcasting operations.</p>
<p>This functional constraint enables JAX's powerful transformations like jit (compilation), grad (automatic differentiation), vmap (vectorization), and pmap (parallelization). While the functional style requires some adjustment if you're used to imperative programming, it unlocks JAX's ability to automatically optimize and transform your numerical code in ways that would be impossible with stateful operations.</p>
<h2 id="treeclass-objects-in-fdtdx">TreeClass Objects in FDTDX</h2>
<p>FDTDX leverages JAX's functional programming paradigm through a specialized TreeClass system that makes it easy to work with complex hierarchical data structures while maintaining JAX compatibility. The TreeClass provides a clean, object-oriented interface that automatically integrates with JAX's pytree system, allowing for seamless use with JAX transformations.</p>
<h3 id="treeclass-structure">TreeClass Structure</h3>
<p>The TreeClass system uses dataclass-like syntax with the @fdtdx.autoinit decorator to automatically generate initialization methods. Here's how it works:
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">fdtdx</span>

<span class="nd">@fdtdx</span><span class="o">.</span><span class="n">autoinit</span>
<span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">fdtdx</span><span class="o">.</span><span class="n">TreeClass</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>

<span class="nd">@fdtdx</span><span class="o">.</span><span class="n">autoinit</span>
<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">fdtdx</span><span class="o">.</span><span class="n">TreeClass</span><span class="p">):</span>
    <span class="n">a1</span><span class="p">:</span> <span class="n">A</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>

<span class="nd">@fdtdx</span><span class="o">.</span><span class="n">autoinit</span>
<span class="k">class</span><span class="w"> </span><span class="nc">C</span><span class="p">(</span><span class="n">fdtdx</span><span class="o">.</span><span class="n">TreeClass</span><span class="p">):</span>
    <span class="n">b_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">B</span><span class="p">]</span>
    <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span>
</code></pre></div>
These classes can be nested arbitrarily deep and contain lists, dictionaries, or other complex data structures. The @fdtdx.autoinit decorator automatically generates <strong>init</strong> methods that handle default values and type checking.</p>
<h3 id="working-with-treeclass-instances">Working with TreeClass Instances</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Create instances with default or custom values</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="n">A</span><span class="p">())</span>  <span class="c1"># Uses defaults: A(a=2, x=5), z=7</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>  <span class="c1"># Functional update</span>

<span class="c1"># Create more complex nested structures</span>
<span class="n">b2</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="n">A</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">11</span><span class="p">),</span> <span class="n">z</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">b3</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="n">A</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">21</span><span class="p">),</span> <span class="n">z</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>

<span class="c1"># Collections of TreeClass instances</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">b_list</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">b2</span><span class="p">])</span>

<span class="c1"># Deep nested updates using path syntax</span>
<span class="n">c2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="s2">&quot;b_list-&gt;[0]-&gt;a1-&gt;a&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div>
<h3 id="the-aset-method-functional-updates-made-easy">The aset Method: Functional Updates Made Easy</h3>
<p>The aset method is the cornerstone of FDTDX's functional approach. Unlike JAX's standard .at[].set() which only works on pytree leaf nodes (typically arrays), aset can update any attribute at any level of nesting within a TreeClass hierarchy.</p>
<h3 id="path-syntax-the-method-uses-an-intuitive-string-based-path-syntax-to-navigate-nested-structures">Path Syntax: The method uses an intuitive string-based path syntax to navigate nested structures:</h3>
<ul>
<li>"attribute" - Direct attribute access</li>
<li>"a-&gt;b" - Nested attribute access (a.b)</li>
<li>"a-&gt;[0]" - List indexing</li>
<li>"a-&gt;['key']" - Dictionary key access</li>
<li>"b_list-&gt;[0]-&gt;a1-&gt;a" - Complex nested path</li>
</ul>
<p>In the example c2 = c.aset("b_list-&gt;[0]-&gt;a1-&gt;a", 100), this path means:
- Access the b_list attribute of c
- Get the first element [0] of that list
- Access the a1 attribute of that element
- Access the a attribute of a1
- Set that value to 100</p>
<p>The method returns a completely new instance with the updated value, maintaining JAX's functional programming requirements. This allows FDTDX data structures to be used seamlessly with JAX transformations like jit, grad, and vmap, while providing a much more intuitive interface than manually reconstructing nested data structures.
This approach bridges the gap between JAX's powerful functional capabilities and the practical need for complex, hierarchical data management in scientific computing applications.</p>
<h2 id="how-jax-is-used-in-fdtdx">How JAX is used in FDTDX</h2>
<p>For a full example on how to use JAX with fdtdx, check out this <a href="https://github.com/ymahlau/fdtdx/blob/main/examples/simulate_gaussian_source.py">example</a> or this <a href="https://github.com/ymahlau/fdtdx/blob/main/examples/optimize_ceviche_corner.py">example</a>. The script demonstrates FDTDX's seamless integration with JAX's jit transformation. The core simulation function sim_fn takes FDTDX TreeClass structures as arguments and is JIT-compiled:
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sim_fn</span><span class="p">(</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">fdtdx</span><span class="o">.</span><span class="n">ParameterContainer</span><span class="p">,</span>
    <span class="n">arrays</span><span class="p">:</span> <span class="n">fdtdx</span><span class="o">.</span><span class="n">ArrayContainer</span><span class="p">,</span> 
    <span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Complex FDTD simulation logic with TreeClass structures</span>
    <span class="n">arrays</span><span class="p">,</span> <span class="n">new_objects</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">fdtdx</span><span class="o">.</span><span class="n">apply_params</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">final_state</span> <span class="o">=</span> <span class="n">fdtdx</span><span class="o">.</span><span class="n">run_fdtd</span><span class="p">(</span><span class="n">arrays</span><span class="o">=</span><span class="n">arrays</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="n">new_objects</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="c1"># ... more operations</span>
    <span class="k">return</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">new_info</span>
<span class="n">jitted_loss</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">sim_fn</span><span class="p">,</span> <span class="n">donate_argnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;arrays&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div></p>
<h3 id="jit-compilation-with-treeclass-arguments">JIT compilation with TreeClass arguments</h3>
<p>Key Features:</p>
<ul>
<li>TreeClass Compatibility: The ParameterContainer and ArrayContainer are FDTDX TreeClass structures that work seamlessly with jit. JAX automatically handles the pytree registration, allowing these complex nested structures to be compiled efficiently.</li>
<li>Memory Optimization: The donate_argnames=["arrays"] parameter tells JAX it can reuse the memory of the arrays argument, which is crucial for large electromagnetic field arrays in FDTD simulations.</li>
<li>Compilation Pipeline: The script uses .lower().compile() to explicitly control the compilation process, providing timing information for performance analysis.</li>
</ul>
<p>While this specific example focuses on forward simulation, FDTDX is designed for gradient-based optimization. The GradientConfig setup shows how gradients would be computed:
<div class="highlight"><pre><span></span><code><span class="n">gradient_config</span> <span class="o">=</span> <span class="n">fdtdx</span><span class="o">.</span><span class="n">GradientConfig</span><span class="p">(</span>
    <span class="n">recorder</span><span class="o">=</span><span class="n">fdtdx</span><span class="o">.</span><span class="n">Recorder</span><span class="p">(</span>
        <span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="n">fdtdx</span><span class="o">.</span><span class="n">DtypeConversion</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)]</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
For gradient computation, you would typically use:
<div class="highlight"><pre><span></span><code><span class="c1"># Hypothetical gradient computation</span>
<span class="n">grad_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">sim_fn</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Gradient w.r.t. params</span>
<span class="n">gradients</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../.." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../object_placement/" class="btn btn-neutral float-right" title="Object Placement">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Maintained by Yannik Mahlau</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/ymahlau/fdtdx" class="fa fa-code-fork" style="color: #fcfcfc"> ymahlau/fdtdx</a>
        </span>
    
    
      <span><a href="../.." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../object_placement/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../javascripts/mathjax.js"></script>
      <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
